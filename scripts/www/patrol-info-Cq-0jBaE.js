import{r as v,h as Z,z as ee,w as ae,b as m,d as i,l as c,u as E,A as j,g as f,ak as le,F as U,i as x,I as te,J as oe,M as ne,j as F,U as se,C as R,H as P,a6 as re,al as ie,E as ue,am as de,o as u,t as C,an as ce,ao as me}from"./.pnpm-B-_m2kGH.js";import{_ as ve}from"./navBar-Sc4C80VW.js";import{a as fe}from"./index-CpPjdPay.js";import{g as pe,o as N,b as ge,c as ye}from"./index-Bxo7U9o_.js";import{u as be,a as _e}from"./dict-CwYOActj.js";import{_ as ke}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./request-C1_hm9C_.js";import"./index-DyucNCMT.js";const we={class:"patrol-info"},he={class:"info"},Ce={class:"label"},Ie={key:0,class:"value"},Ve={style:{"margin-bottom":"12px"}},Ue={class:"label"},xe={class:"value"},Fe={class:"cell-item"},Pe={class:"cell-item"},Ne={class:"cell-item"},je={class:"label"},De={class:"cell-item"},Le={key:0,class:"formTitle"},Se={__name:"patrol-info",setup(Te){const D=ue(),L=Z(),{inspection_type:A,acceptance_form:M,inspection_form:z}=be("inspection_type","acceptance_form","inspection_form");v(L.query.id);const S=v(L.query.inspectionInfoId),s=v({}),T=v(null),g=v(!1),G=async()=>{let a=await pe(S.value);a.data.signImgUrl&&(g.value=!0,r.value.image=await V(a.data.signImgUrl),R("该巡检记录已有签名，无法修改记录")),a.data.sceneImgUrl&&a.data.sceneImgUrl.length>0&&(_.value=a.data.sceneImgUrl,_.value.forEach(async e=>{r.value.value.push({url:await V(e),isImage:!0})})),a.data.jobContentImg&&r.value.images.push({url:await V(a.data.jobContentImg.staff_briefed_contact_left),isImage:!0}),r.value.remark=a.data.remark,s.value=a.data,s.value.type===0?h.value=z.value.map(e=>({id:e.value,label:e.label,value:s.value.jobContent?s.value.jobContent[e.value]:0,key:e.value})):s.value.type===1&&(h.value=M.value.map(e=>({id:e.value,label:e.label,value:s.value.jobContent?s.value.jobContent[e.value]:0,key:e.value})));for(let e in a.data)w.value.forEach(l=>{l.key==e&&(l.value=a.data[e])});(a.data.queryInspectionFacilityItemList?a.data.queryInspectionFacilityItemList:[]).forEach(e=>{const l=[{id:1,label:"加油机连接器编号",value:"",key:"oilCollectorNo"},{id:2,label:"编码器数量",value:"",key:"coderCount"},{id:3,label:"显示器采集器编号",value:"",key:"oilScreenNo"},{id:4,label:"油品",value:"",key:"oilType"},{id:5,label:"油枪编号",value:"",key:"gunNo"},{id:6,label:"报税口编号",value:"",key:"taxNo"},{id:7,label:"加油机出厂编号",value:"",key:"machineModel"}];for(let t in e)l.forEach(n=>{n.key==t&&(n.value=e[t])});B.value.push(l)})};ee(()=>{G()});const w=v([{id:1,label:"加油站名称",value:"",flag:!1,key:"stationName"},{id:2,label:"统一社会信用代码",value:"",flag:!1,key:"unifiedCreditCode"},{id:3,label:"地址",value:"",icon:"edit",flag:!0,key:"address"},{id:4,label:"负责人姓名",value:"",icon:"edit",flag:!0,key:"responsiblePersonName"},{id:5,label:"负责人电话",value:"",icon:"edit",flag:!0,key:"responsiblePersonPhone"},{id:6,label:"加油机网关编号",value:"",flag:!1,key:"stationGatewayNo"},{id:7,label:"液位仪品牌",value:"",flag:!1,key:"opwManufacturer"},{id:8,label:"液位仪路由器编号",value:"",flag:!1,key:"opwGatewayNo"},{id:9,label:"液位仪出厂编号",value:"",flag:!1,key:"opwSn"}]),B=v([]),h=v([]),I=v(!1);ae(()=>h.value,a=>{a.length>0&&(a.find(l=>l.id=="staff_briefed_contact_left").value?I.value=!0:(r.value.images=[],I.value=!1))},{deep:!0});const _=v([]),r=v({images:[],value:[],signImgUrl:"",image:""}),q=a=>a.size/1024/1024<=5?Promise.resolve(a):new Promise((l,t)=>{new de(a,{quality:.6,success(n){l(n)},error(n){console.error("图片压缩失败:",n.message),t(n)}})}),O=a=>a.type=="image/png"?(re("不允许上传PNG格式图片"),!1):!0,$=async a=>{let e=P({message:"图片上传...",forbidClick:!0,duration:0});const l=new FormData;l.append("file",a.file),l.append("fileType","54");let t=await N(l);r.value.jobContentImg={staff_briefed_contact_left:t.data},e.close()},H=async(a,e)=>(_.value.splice(e.index,1),!0),J=async a=>{let e=P({message:"巡检图片上传...",forbidClick:!0,duration:0});try{if(Array.isArray(a))await Promise.all(a.map(async l=>{let t=await q(l.file);const n=new FormData;n.append("file",t),n.append("fileType","54");let p=await N(n);_.value.push(p.data)}));else{let l=await q(a.file);const t=new FormData;t.append("file",l),t.append("fileType","54");let n=await N(t);_.value.push(n.data)}}catch{P({message:"上传失败"})}finally{e.close()}},V=async a=>new Promise(async(e,l)=>{let t=await ye({url:a});e(t.data)}),W=async a=>{if(!a.image){R("请先签名");return}const e=a.image.replace(/^data:[^;]+;base64,/,""),l=atob(e),t=new ArrayBuffer(l.length),n=new Uint8Array(t);for(let y=0;y<l.length;y++)n[y]=l.charCodeAt(y);const p=new Blob([t],{type:"image/png"}),k=new FormData;k.append("file",p),k.append("fileType","53");let d=await N(k);if(d.code==200){r.value.signImgUrl=d.data;let y=await V(d.data);r.value.image=y}},K=()=>{T.value.validate().then(async()=>{let a=P({message:"正在提交...",forbidClick:!0,duration:0}),e=w.value.filter(d=>d.key=="responsiblePersonName")[0].value,l=w.value.filter(d=>d.key=="address")[0].value,t=w.value.filter(d=>d.key=="responsiblePersonPhone")[0].value,p={jobContent:Object.fromEntries(h.value.map(d=>[d.key,d.value?1:0])),jobContentImg:{...r.value.jobContentImg},id:S.value,imgType:"signImgUrl",responsiblePersonName:e,address:l,responsiblePersonPhone:t,urlList:_.value,signImgUrl:r.value.signImgUrl,remark:r.value.remark,machineCount:s.value.machineCount,taxCount:s.value.taxCount,gunCount:s.value.gunCount};if((await ge(p)).code==200){if(s.value.type==1){fe({installStatus:5}),a.close(),D.replace("/setup");return}a.close(),D.replace({path:"/station-patrol/patrol-list",query:{id:s.value.stationId}})}})},Q=()=>{console.log("清除签名")};return(a,e)=>{const l=ve,t=oe,n=le,p=te,k=ce,d=se,y=ie,X=me,Y=ne;return u(),m("div",we,[i(l,{title:`${E(_e)(s.value.type,E(A))}详情`},null,8,["title"]),c("div",he,[i(p,{title:"基础信息"},{default:f(()=>[i(n,null,{title:f(()=>[(u(!0),m(U,null,x(w.value,o=>(u(),m("div",{class:"cell-item",key:o.id},[c("div",Ce,C(o.label),1),o.flag?(u(),F(t,{key:1,style:{width:"180px"},border:"",modelValue:o.value,"onUpdate:modelValue":b=>o.value=b,readonly:g.value,placeholder:"请输入"+o.label,"input-align":"right","right-icon":"edit"},null,8,["modelValue","onUpdate:modelValue","readonly","placeholder"])):(u(),m("div",Ie,C(o.value),1))]))),128))]),_:1})]),_:1}),i(p,{title:"验收内容",style:{"background-color":"#F8F8F8"}},{default:f(()=>[(u(!0),m(U,null,x(B.value,o=>(u(),m("div",Ve,[i(n,null,{title:f(()=>[(u(!0),m(U,null,x(o,b=>(u(),m("div",{class:"cell-item",key:b.id},[c("div",Ue,C(b.label),1),c("div",xe,C(b.value),1)]))),128))]),_:2},1024)]))),256))]),_:1}),i(p,{title:"合计",style:{"background-color":"#F8F8F8"}},{default:f(()=>[i(n,null,{title:f(()=>[c("div",Fe,[e[6]||(e[6]=c("div",{class:"label"},"加油机数量",-1)),i(t,{style:{width:"180px"},border:"",modelValue:s.value.machineCount,"onUpdate:modelValue":e[0]||(e[0]=o=>s.value.machineCount=o),readonly:g.value,"input-align":"right","right-icon":"edit"},null,8,["modelValue","readonly"])]),c("div",Pe,[e[7]||(e[7]=c("div",{class:"label"},"报税口",-1)),i(t,{style:{width:"180px"},border:"",modelValue:s.value.taxCount,"onUpdate:modelValue":e[1]||(e[1]=o=>s.value.taxCount=o),readonly:g.value,"input-align":"right","right-icon":"edit"},null,8,["modelValue","readonly"])]),c("div",Ne,[e[8]||(e[8]=c("div",{class:"label"},"加油枪",-1)),i(t,{style:{width:"180px"},border:"",modelValue:s.value.gunCount,"onUpdate:modelValue":e[2]||(e[2]=o=>s.value.gunCount=o),readonly:g.value,"input-align":"right","right-icon":"edit"},null,8,["modelValue","readonly"])])]),_:1})]),_:1}),i(p,{title:"工作内容"},{default:f(()=>[i(n,null,{title:f(()=>[(u(!0),m(U,null,x(h.value,o=>(u(),m("div",{class:"cell-item",key:o.id},[c("div",je,C(o.label),1),i(k,{modelValue:o.value,"onUpdate:modelValue":b=>o.value=b},null,8,["modelValue","onUpdate:modelValue"])]))),128)),c("div",De,[e[9]||(e[9]=c("div",{class:"label"},"备注",-1)),i(t,{disabled:g.value,"input-align":"right",modelValue:r.value.remark,"onUpdate:modelValue":e[3]||(e[3]=o=>r.value.remark=o),rows:"2",autosize:"",type:"textarea",placeholder:"请输入备注"},null,8,["disabled","modelValue"])]),i(Y,{ref_key:"formRef",ref:T},{default:f(()=>[I.value?(u(),m("div",Le,"留下联系方式图片")):j("",!0),I.value?(u(),F(t,{key:1,name:"images",rules:[{required:!0,message:"请上传留痕照片"}]},{input:f(()=>[i(d,{modelValue:r.value.images,"onUpdate:modelValue":e[4]||(e[4]=o=>r.value.images=o),"after-read":$,"max-count":1},null,8,["modelValue"])]),_:1})):j("",!0),e[10]||(e[10]=c("div",{class:"formTitle"},"巡检照片",-1)),i(t,{name:"uploader",rules:[{required:!0,message:"请上传巡检照片"}]},{input:f(()=>[i(d,{modelValue:r.value.value,"onUpdate:modelValue":e[5]||(e[5]=o=>r.value.value=o),beforeRead:O,"after-read":J,readonly:g.value,"before-delete":H,multiple:"","max-count":6},null,8,["modelValue","readonly"])]),_:1}),r.value.image?(u(),F(y,{key:2,src:r.value.image},null,8,["src"])):(u(),F(X,{key:3,onSubmit:W,onClear:Q}))]),_:1},512)]),_:1})]),_:1}),g.value?j("",!0):(u(),m("div",{key:0,class:"btn",onClick:K},"完成"))])])}}},Oe=ke(Se,[["__scopeId","data-v-81e1b13c"]]);export{Oe as default};
